<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è½ã¨ã—ç‰©ã‚¯ãƒ©ã‚¦ãƒ‰ï¼ˆä»®ï¼‰ - ãƒ¢ãƒã‚¤ãƒ«ç™»éŒ²</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap');
    :root {
      --primary: #1F3A8A;
      --primary-hover: #162D70;
      --primary-light: #E3E8F9;
      --secondary: #0E7490;
      --bg: #F8FAFC;
      --card: #FFFFFF;
      --border: #E5E7EB;
      --muted: #6B7280;
      --heading: #111827;
      --warning: #F59E0B;
      --danger: #DC2626;
    }
    .glow { display: none; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', 'Noto Sans JP', system-ui, -apple-system, sans-serif;
      background:
        linear-gradient(180deg, #F8FAFC 0%, #F3F4F6 40%, #F8FAFC 100%);
      color: var(--heading);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 24px;
      position: relative;
      overflow-x: hidden;
      overflow-y: auto;
    }
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cg fill='%23FFFFFF' fill-opacity='0.08'%3E%3Ccircle cx='5' cy='5' r='1.2'/%3E%3Ccircle cx='120' cy='40' r='1'/%3E%3Ccircle cx='180' cy='120' r='1'/%3E%3Ccircle cx='60' cy='160' r='1'/%3E%3C/g%3E%3C/svg%3E");
    }
    .frame {
      width: min(430px, 100%);
      background: linear-gradient(180deg, #FFFFFF, #F6F7FB);
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,0.04);
      box-shadow: 0 8px 26px rgba(15, 23, 42, 0.16);
      overflow: hidden;
      position: relative;
      isolation: isolate;
    }
    .screen {
      padding: 14px;
      display: grid;
      gap: 10px;
      min-height: 620px;
      position: relative;
      background: linear-gradient(180deg, #FFFFFF 0%, #F8FAFC 100%);
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 700;
      color: var(--heading);
    }
    .brand {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .brand-mark {
      width: 30px;
      height: 30px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 800;
      font-size: 12px;
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.22);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 9px;
      background: #E5E7EB;
      color: #1F2937;
      border-radius: 999px;
      font-weight: 700;
      font-size: 11px;
    }
    .progress {
      position: relative;
      height: 6px;
      border-radius: 999px;
      background: #E5E7EB;
      overflow: hidden;
    }
    .progress .bar {
      position: absolute;
      inset: 0;
      width: 25%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: width 0.25s ease;
    }
    .step-labels {
      display: flex;
      justify-content: space-between;
      color: var(--muted);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    .steps {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 6px;
      pointer-events: none;
    }
    .step-chip {
      padding: 10px 8px;
      border-radius: 10px;
      background: #E5E7EB;
      color: #6B7280;
      font-weight: 800;
      font-size: 12px;
      text-align: center;
      transition: all 0.15s ease;
    }
    .step-chip.active {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 4px 12px rgba(31, 58, 138, 0.16);
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      display: grid;
      gap: 10px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
      animation: fadeUp 0.35s ease;
    }
    .card h3 { margin: 0; font-size: 16px; }
    .card p { margin: 0; color: var(--muted); font-size: 13px; }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .option {
      background: #F8FAFC;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 10px;
      text-align: center;
      font-weight: 700;
      font-size: 13px;
      color: #374151;
      cursor: pointer;
      transition: transform 0.12s ease, border-color 0.12s ease, box-shadow 0.12s ease, background 0.15s ease;
      display: grid;
      gap: 4px;
    }
    .option:hover { transform: translateY(-1px); border-color: #D7E3FF; }
    .option.active {
      border-color: rgba(31,58,138,0.9);
      background: #EEF0FB;
      color: #162D70;
      box-shadow: 0 4px 12px rgba(31, 58, 138, 0.12);
      transform: scale(1.01);
    }

    .photo {
      width: 100%;
      aspect-ratio: 1/1;
      border-radius: 12px;
      border: 1px dashed #E5E7EB;
      background:
        linear-gradient(135deg, rgba(31,58,138,0.02), rgba(14,116,144,0.02));
      display: grid;
      place-items: center;
      color: var(--muted);
      font-weight: 700;
      position: relative;
      overflow: hidden;
    }
    .photo img { width: 100%; height: 100%; object-fit: cover; }
    .photo .hint {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.55);
      color: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      animation: pulse 1.6s ease infinite;
    }

    .field { display: grid; gap: 6px; }
    .label { font-size: 12px; color: var(--muted); font-weight: 700; }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #D1D5DB;
      border-radius: 10px;
      background: #fff;
      font-size: 14px;
      color: #374151;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.12s ease;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.14);
      transform: translateY(-1px);
    }
    textarea { resize: vertical; min-height: 74px; }

    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      background: #F3F4F6;
      border: 1px solid var(--border);
      color: #4B5563;
      font-weight: 700;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.12s ease;
    }
    .chip.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 4px 10px rgba(31, 58, 138, 0.14); }

    .summary {
      background: #F8FAFC;
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 12px;
      display: grid;
      gap: 8px;
    }
    .summary-row { display: flex; justify-content: space-between; font-size: 13px; color: #374151; }
    .summary-row span { color: var(--muted); }

    .actions {
      position: sticky;
      bottom: 0;
      background: linear-gradient(180deg, rgba(249,250,251,0.85), rgba(249,250,251,0.98));
      padding: 12px 0 6px;
      display: grid;
      gap: 8px;
      backdrop-filter: blur(12px);
    }
    .btn {
      width: 100%;
      padding: 13px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.15s ease;
      font-size: 14px;
    }
    .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 8px 18px rgba(31, 58, 138, 0.2); }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 8px 18px rgba(31, 58, 138, 0.18); }
    .btn.disabled {
      background: #DDE7FF;
      color: #94A3B8;
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
    }
    .btn-ghost { background: transparent; color: var(--muted); }
    .btn-outline { background: #fff; border: 1px solid var(--border); color: var(--heading); }

    .error {
      color: var(--danger);
      font-size: 12px;
      font-weight: 700;
    }

    .toast {
      position: fixed;
      top: 18px;
      right: 50%;
      transform: translateX(50%) translateY(-10px);
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      box-shadow: 0 10px 22px rgba(15,23,42,0.2);
      font-weight: 700;
      opacity: 0;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 20;
    }
    .toast.show { opacity: 1; transform: translateX(50%) translateY(0); }

    .hint-inline { font-size: 12px; color: var(--muted); }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 12px;
      background: #0F172A;
      color: #fff;
      border-radius: 12px;
      font-weight: 700;
      font-size: 12px;
    }
    .done-card {
      position: relative;
      text-align: center;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #FFFFFF 0%, #EEF2FF 100%);
      display: grid;
      gap: 12px;
      overflow: hidden;
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.14);
      animation: fadeUp 0.35s ease;
    }
    .done-card::before {
      content: '';
      position: absolute;
      inset: -40% -20% auto;
      height: 200px;
      background: radial-gradient(70% 80% at 20% 10%, rgba(31, 58, 138, 0.14), transparent 60%);
      opacity: 0.7;
      pointer-events: none;
    }
    .done-check {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      margin: 0 auto;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      font-size: 28px;
      font-weight: 800;
      box-shadow: 0 12px 24px rgba(31, 58, 138, 0.24);
    }
    .done-title {
      font-size: 18px;
      font-weight: 800;
      color: var(--heading);
    }
    .done-sub {
      font-size: 13px;
      color: var(--muted);
    }
    .done-id {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 12px;
      background: #0F172A;
      color: #fff;
      font-weight: 800;
      letter-spacing: 0.08em;
      margin: 0 auto;
    }
    .done-id span {
      font-size: 10px;
      opacity: 0.7;
      letter-spacing: 0.12em;
    }
    .done-meta {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: grid;
      gap: 8px;
      text-align: left;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
    }
    .done-meta .row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      color: #475569;
    }
    .done-meta .row span { color: var(--muted); }
    .done-meta .row strong { color: var(--heading); }
    .done-actions {
      display: grid;
      gap: 8px;
    }

    .mini-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: grid;
      gap: 10px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
    }
    .mini-divider { height: 1px; background: var(--border); margin: 8px 0; }
    .slide-card {
      animation: slideFade 0.22s ease;
    }
    @keyframes slideFade {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 9px 11px;
      border-radius: 10px;
      background: #F3F4F6;
      border: 1px solid var(--border);
      cursor: pointer;
      font-weight: 700;
      color: #374151;
      transition: all 0.12s ease;
      position: relative;
      overflow: hidden;
    }
    .toggle::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(60% 100% at 10% 10%, rgba(31,58,138,0.1), transparent 60%);
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    .toggle.on {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary);
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.14);
    }
    .toggle.on::after { opacity: 1; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.04); opacity: 0.85; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="frame">
    <div class="glow"></div>
    <div class="screen">
      <div class="topbar">
        <div class="brand">
          <div class="brand-mark">LC</div>
          <div>
            <div style="font-weight:800;">èŠ±æœˆæ—…é¤¨ æœ¬é¤¨</div>
            <div style="color:var(--muted); font-size:11px;">æ¸…æƒãƒ»å€‰åº«ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</div>
          </div>
        </div>
        <div class="pill" id="stepTag">STEP 1/4</div>
      </div>

      <div class="progress"><div class="bar" id="progressBar"></div></div>
      <div class="steps" aria-hidden="true">
        <div class="step-chip" data-step="0">ã‚«ãƒ†ã‚´ãƒª</div>
        <div class="step-chip" data-step="1">å†™çœŸ</div>
        <div class="step-chip" data-step="2">è©³ç´°</div>
        <div class="step-chip" data-step="3">ä¿ç®¡</div>
      </div>

      <div id="view"></div>

      <div class="actions">
        <button class="btn btn-primary" id="nextBtn">æ¬¡ã¸</button>
        <button class="btn btn-ghost" id="backBtn">ï¼œ æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ</div>

  <script>
    const view = document.getElementById('view');
    const nextBtn = document.getElementById('nextBtn');
    const backBtn = document.getElementById('backBtn');
    const stepTag = document.getElementById('stepTag');
    const progressBar = document.getElementById('progressBar');
    const toast = document.getElementById('toast');
    const actionBar = document.querySelector('.actions');

    const categories = [
      { key: 'wallet', label: 'è²¡å¸ƒ' },
      { key: 'bag', label: 'ã‚«ãƒãƒ³ãƒ»ãƒãƒ¼ãƒ' },
      { key: 'phone', label: 'ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³' },
      { key: 'charger', label: 'å……é›»å™¨ãƒ»ã‚±ãƒ¼ãƒ–ãƒ«' },
      { key: 'key', label: 'éµãƒ»ã‚«ãƒ¼ãƒ‰ã‚­ãƒ¼' },
      { key: 'clothes', label: 'è¡£é¡' },
      { key: 'accessory', label: 'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³å°ç‰©' },
      { key: 'glasses', label: 'ãƒ¡ã‚¬ãƒ' },
      { key: 'cosme', label: 'åŒ–ç²§å“' },
      { key: 'shoes', label: 'é´ãƒ»ã‚µãƒ³ãƒ€ãƒ«' },
      { key: 'umbrella', label: 'å‚˜' },
      { key: 'other', label: 'ãã®ä»–' }
    ];

    let step = 0;
    const state = {
      category: '',
      photo: '',
      foundDate: 'ä»Šæ—¥',
      stay: '',
      place: '301å·å®¤',
      room: '301',
      note: '',
      storage: 'å€‰åº«A-3',
      deadline: '2025/03/31',
      id: 'A-023'
    };

    const formState = {};

    function ensureForm(catKey) {
      if (!formState[catKey]) formState[catKey] = { __open: {} };
      if (!formState[catKey].__open) formState[catKey].__open = {};
      return formState[catKey];
    }

    function lookupCategoryLabel(key) {
      const hit = categories.find(c => c.key === key);
      return hit ? hit.label : '';
    }

    function setToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 1800);
    }

    function updateStepChips() {
      const activeIndex = Math.min(step, 3);
      document.querySelectorAll('.step-chip').forEach(chip => {
        const idx = Number(chip.dataset.step);
        chip.classList.toggle('active', idx === activeIndex);
      });
    }

    function updateNextLabel() {
      if (step === 0 && !state.category) {
        nextBtn.textContent = 'ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„';
        nextBtn.classList.add('disabled');
        return;
      }
      nextBtn.classList.remove('disabled');
      if (step === 0) nextBtn.textContent = 'æ¬¡ã¸ï¼ˆå†™çœŸã‚’æ’®å½±ï¼‰';
      if (step === 1) nextBtn.textContent = 'æ¬¡ã¸ï¼ˆè©³ç´°å…¥åŠ›ï¼‰';
      if (step === 2) nextBtn.textContent = 'æ¬¡ã¸ï¼ˆä¿ç®¡å ´æ‰€ï¼‰';
      if (step === 3) nextBtn.textContent = 'ã“ã®å†…å®¹ã§ç™»éŒ²ã™ã‚‹';
      if (step === 4) nextBtn.textContent = 'ç¶šã‘ã¦ç™»éŒ²ã™ã‚‹';
    }

    function render() {
      stepTag.textContent = step < 4 ? `STEP ${step+1}/4` : 'å®Œäº†';
      progressBar.style.width = `${Math.min((step+1)/4, 1) * 100}%`;
      backBtn.style.visibility = step === 0 ? 'hidden' : 'visible';
      if (actionBar) actionBar.style.display = step === 4 ? 'none' : 'grid';
      updateStepChips();
      updateNextLabel();

      if (step === 0) renderCategory();
      if (step === 1) renderPhoto();
      if (step === 2) renderDetail();
      if (step === 3) renderStorage();
      if (step === 4) renderDone();
    }

    const commonColors = ['é»’','ç™½','ã‚°ãƒ¬ãƒ¼','ç´º','èŒ¶','ãã®ä»–'];

    const miniForms = {
      wallet: {
        title: 'è²¡å¸ƒã®ç‰¹å¾´ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆ2ã€œ3é …ç›®ã§OKã§ã™ï¼‰',
        sections: [
          { title: 'ç¨®é¡', fields: [{ type: 'pill', key: 'type', options: ['é•·è²¡å¸ƒ','äºŒã¤æŠ˜ã‚Š','ä¸‰ã¤æŠ˜ã‚Š','å°éŠ­å…¥ã‚Œ','ã‚«ãƒ¼ãƒ‰ã‚±ãƒ¼ã‚¹','ãƒ‘ã‚¹ã‚±ãƒ¼ã‚¹'] }] },
          { title: 'â–¼ ç´ æãƒ»é‡‘å…·ã‚’è©³ã—ãå…¥ã‚Œã‚‹ï¼ˆä»»æ„ï¼‰', collapsible: true, fields: [
            { type: 'pill', key: 'material', label: 'ç´ æ', options: ['é©','å¸ƒãƒ»ã‚­ãƒ£ãƒ³ãƒã‚¹','ãƒŠã‚¤ãƒ­ãƒ³','åˆçš®','ãã®ä»–'] },
            { type: 'pill', key: 'fastener', label: 'é–‹ãæ–¹ãƒ»é‡‘å…·', options: ['ãƒ•ã‚¡ã‚¹ãƒŠãƒ¼','ãƒœã‚¿ãƒ³ç•™ã‚','ãŒã¾å£','ä½•ã‚‚ãªã—'] }
          ]},
          { title: 'å…±é€š', fields: [
            { type: 'pill', key: 'color', label: 'è‰²', options: commonColors, allowCustom: true, customKey: 'colorNote', customPlaceholder: 'è‰²ã‚’è¿½è¨˜ï¼ˆä»»æ„ï¼‰' },
            { type: 'text', key: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ­ã‚´å', placeholder: 'ä¾‹ï¼‰COACH / ãƒ­ã‚´ãªã— ãªã©' },
            { type: 'text', key: 'note', label: 'ç‰¹å¾´ãƒ¡ãƒ¢', placeholder: 'ä¾‹ï¼‰å†…å´ã«ã‚¤ãƒ‹ã‚·ãƒ£ãƒ« / ã–ã£ãã‚Šã§OKã§ã™' }
          ]}
        ]
      },
      bag: {
        title: 'ã‚«ãƒãƒ³ãƒ»ãƒãƒ¼ãƒã®ç‰¹å¾´ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆ2ã€œ3é …ç›®ã§OKã§ã™ï¼‰',
        sections: [
          { title: 'ç¨®é¡', fields: [{ type: 'pill', key: 'bagType', options: ['ãƒªãƒ¥ãƒƒã‚¯','ãƒˆãƒ¼ãƒˆãƒãƒƒã‚°','ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒãƒƒã‚°','ãƒœã‚¹ãƒˆãƒ³ãƒãƒƒã‚°','ã‚¨ã‚³ãƒãƒƒã‚°','ãƒãƒ¼ãƒ'] }] },
          { title: 'â–¼ ã‚µã‚¤ã‚ºã¨æŸ„ï¼ˆå¿…è¦ãªã‚‰ï¼‰', collapsible: true, fields: [
            { type: 'pill', key: 'bagSize', label: 'ã‚µã‚¤ã‚ºæ„Ÿ', options: ['å¤§ï¼ˆæ—…è¡Œã‚«ãƒãƒ³ï¼‰','ä¸­ï¼ˆA4ãŒå…¥ã‚‹ï¼‰','å°ï¼ˆè²¡å¸ƒãŒå…¥ã‚‹ç¨‹åº¦ï¼‰'] },
            { type: 'pill', key: 'bagPattern', label: 'æŸ„ãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³', options: ['ç„¡åœ°','ãƒã‚§ãƒƒã‚¯','ã‚¹ãƒˆãƒ©ã‚¤ãƒ—','èŠ±æŸ„','ãƒ­ã‚´å¤§ãã‚'] }
          ]},
          { title: 'å…±é€š', fields: [
            { type: 'pill', key: 'color', label: 'è‰²', options: commonColors, allowCustom: true, customKey: 'colorNote', customPlaceholder: 'è‰²ã‚’è¿½è¨˜ï¼ˆä»»æ„ï¼‰' },
            { type: 'text', key: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ­ã‚´å', placeholder: 'ä¾‹ï¼‰ç„¡å° / COACH / ãƒ­ã‚´ãªã— ãªã©' },
            { type: 'text', key: 'note', label: 'ç‰¹å¾´ãƒ¡ãƒ¢', placeholder: 'ä¾‹ï¼‰ãƒã‚±ãƒƒãƒˆå¤šã‚ / ã–ã£ãã‚Šã§OKã§ã™' }
          ]}
        ]
      },
      phone: {
        title: 'ã‚¹ãƒãƒ›ãƒ»æºå¸¯ã®ç‰¹å¾´ã‚’æ•™ãˆã¦ãã ã•ã„',
        sections: [
          { title: 'æ©Ÿç¨®ã‚¿ã‚¤ãƒ—', fields: [{ type: 'pill', key: 'deviceType', options: ['iPhone','Android','ã‚¬ãƒ©ã‚±ãƒ¼','ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ','ä¸æ˜'] }] },
          { title: 'ã‚±ãƒ¼ã‚¹ã¾ã‚ã‚Š', fields: [
            { type: 'pill', key: 'casePresence', label: 'ã‚±ãƒ¼ã‚¹ã®æœ‰ç„¡', options: ['ã‚±ãƒ¼ã‚¹ã‚ã‚Š','ã‚±ãƒ¼ã‚¹ãªã—','ä¸æ˜'] },
            { type: 'pill', key: 'caseType', label: 'ã‚±ãƒ¼ã‚¹ã®ç¨®é¡', options: ['æ‰‹å¸³å‹','ã‚¯ãƒªã‚¢ã‚±ãƒ¼ã‚¹','æŸ„å…¥ã‚Šã‚±ãƒ¼ã‚¹','è¤‡æ•°è‰²','ãã®ä»–'], showIf: (f)=>f.casePresence==='ã‚±ãƒ¼ã‚¹ã‚ã‚Š' }
          ]},
          { title: 'å…±é€š', fields: [
            { type: 'pill', key: 'bodyColor', label: 'è‰²ï¼ˆæœ¬ä½“ or ã‚±ãƒ¼ã‚¹ï¼‰', options: commonColors, allowCustom: true, customKey: 'bodyNote', customPlaceholder: 'è‰²ã‚’è¿½è¨˜ï¼ˆä»»æ„ï¼‰' },
            { type: 'text', key: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ­ã‚´å', placeholder: 'ä¾‹ï¼‰Apple / Galaxy / Xperia / ãƒ­ã‚´ãªã— ãªã©' },
            { type: 'text', key: 'note', label: 'ç‰¹å¾´ãƒ¡ãƒ¢', placeholder: 'ä¾‹ï¼‰ãƒãƒƒãƒ—ã‚½ã‚±ãƒƒãƒˆ / ç”»é¢ä¸Šéƒ¨ãƒ’ãƒ“ ãªã©' }
          ]}
        ]
      },
      charger: {
        title: 'å……é›»å™¨ãƒ»ã‚±ãƒ¼ãƒ–ãƒ«ã®ç‰¹å¾´',
        sections: [
          { title: 'ç¨®é¡', fields: [{ type: 'pill', key: 'chargerType', options: ['ã‚³ãƒ³ã‚»ãƒ³ãƒˆä¸€ä½“å‹å……é›»å™¨','ã‚±ãƒ¼ãƒ–ãƒ«ã®ã¿','ãƒ¢ãƒã‚¤ãƒ«ãƒãƒƒãƒ†ãƒªãƒ¼','å……é›»å™¨ï¼‹ã‚±ãƒ¼ãƒ–ãƒ«ã‚»ãƒƒãƒˆ'] }] },
          { title: 'ç«¯å­ã¨é•·ã•', fields: [
            { type: 'pill', key: 'connector', label: 'ç«¯å­ã®ç¨®é¡', options: ['Lightning','USB-C','microUSB','ãã®ä»–','ä¸æ˜'] },
            { type: 'pill', key: 'cableLength', label: 'é•·ã•ï¼ˆä»»æ„ï¼‰', options: ['0.5m','1m','é•·ã‚','å·»ãå–ã‚Š'] }
          ]},
          { title: 'å…±é€š', fields: [
            { type: 'pill', key: 'color', label: 'è‰²', options: ['ç™½','é»’','ã‚°ãƒ¬ãƒ¼','ãã®ä»–'], allowCustom: true, customKey: 'colorNote', customPlaceholder: 'è‰²ã‚’è¿½è¨˜ï¼ˆä»»æ„ï¼‰' },
            { type: 'text', key: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ­ã‚´å', placeholder: 'ä¾‹ï¼‰Anker / Apple / ãƒ­ã‚´ãªã— ãªã©' },
            { type: 'text', key: 'note', label: 'ç‰¹å¾´ãƒ¡ãƒ¢', placeholder: 'ä¾‹ï¼‰å…ˆç«¯ãŒLå­— / å£ãŒå‰²ã‚Œã¦ã„ã‚‹ ãªã©' }
          ]}
        ]
      },
      key: {
        title: 'éµãƒ»ã‚«ãƒ¼ãƒ‰ã‚­ãƒ¼ã®ç‰¹å¾´',
        sections: [
          { title: 'ç¨®é¡', fields: [{ type: 'pill', key: 'keyType', options: ['é‡‘å±ã‚­ãƒ¼','ã‚«ãƒ¼ãƒ‰ã‚­ãƒ¼','è»Šã®ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼','ãã®ä»–'] }] },
          { title: 'æœ¬æ•°ãƒ»ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼', fields: [
            { type: 'pill', key: 'keyCount', label: 'æœ¬æ•°', options: ['1æœ¬','2ã€œ3æœ¬','4æœ¬ä»¥ä¸Š','ä¸æ˜'] },
            { type: 'pill', key: 'keyholder', label: 'ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼', options: ['ã‚ã‚Š','ãªã—'] },
            { type: 'text', key: 'keyholderNote', label: 'ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ã®å†…å®¹', placeholder: 'ä¾‹ï¼‰èµ¤ã„ã‚¿ã‚° / ã‚¯ãƒã®äººå½¢', showIf: (f)=>f.keyholder==='ã‚ã‚Š' }
          ]},
          { title: 'å…±é€š', fields: [
            { type: 'pill', key: 'color', label: 'è‰²', options: commonColors, allowCustom: true, customKey: 'colorNote', customPlaceholder: 'è‰²ã‚’è¿½è¨˜ï¼ˆä»»æ„ï¼‰' },
            { type: 'text', key: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ­ã‚´å', placeholder: 'ä¾‹ï¼‰è»Šãƒ¡ãƒ¼ã‚«ãƒ¼ / ãƒ­ã‚´ãªã— ãªã©' },
            { type: 'text', key: 'note', label: 'ç‰¹å¾´ãƒ¡ãƒ¢', placeholder: 'ä¾‹ï¼‰ã‚­ãƒ¼ã‚¿ã‚°ã«éƒ¨å±‹ç•ªå· / ã–ã£ãã‚Šã§OKã§ã™' }
          ]}
        ]
      },
      clothes: {
        title: 'è¡£é¡ã®ç‰¹å¾´ã‚’æ•™ãˆã¦ãã ã•ã„',
        sections: [
          { title: 'ç¨®é¡', fields: [{ type: 'pill', key: 'clothesType', options: ['ä¸Šç€','ãƒˆãƒƒãƒ—ã‚¹','ãƒœãƒˆãƒ ã‚¹','éƒ¨å±‹ç€ãƒ»ãƒ‘ã‚¸ãƒ£ãƒ','ä¸‹ç€ãƒ»é´ä¸‹'] }] },
          { title: 'â–¼ æŸ„ãƒ»ã‚µã‚¤ã‚ºï¼ˆä»»æ„ï¼‰', collapsible: true, fields: [
            { type: 'pill', key: 'pattern', label: 'æŸ„', options: ['ç„¡åœ°','ãƒœãƒ¼ãƒ€ãƒ¼','ãƒã‚§ãƒƒã‚¯','ãƒ‰ãƒƒãƒˆ','èŠ±æŸ„ãƒ»ç·æŸ„'] },
            { type: 'pill', key: 'size', label: 'ã‚µã‚¤ã‚ºæ„Ÿ', options: ['å­ã©ã‚‚ç”¨','å¤§äºº Sã€œM','å¤§äºº Lä»¥ä¸Š'] }
          ]},
          { title: 'å…±é€š', fields: [
            { type: 'pill', key: 'color', label: 'è‰²', options: commonColors, allowCustom: true, customKey: 'colorNote', customPlaceholder: 'è‰²ã‚’è¿½è¨˜ï¼ˆä»»æ„ï¼‰' },
            { type: 'text', key: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ­ã‚´å', placeholder: 'ä¾‹ï¼‰ãƒ¦ãƒ‹ã‚¯ãƒ­ / ãƒ­ã‚´ãªã— ãªã©' },
            { type: 'text', key: 'note', label: 'ç‰¹å¾´ãƒ¡ãƒ¢', placeholder: 'ä¾‹ï¼‰è¢–ã«ãƒ­ã‚´ / ãƒã‚±ãƒƒãƒˆä»˜ã ãªã©' }
          ]}
        ]
      },
      accessory: {
        title: 'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³å°ç‰©ã®ç‰¹å¾´',
        sections: [
          { title: 'ç¨®é¡', fields: [{ type: 'pill', key: 'accessoryType', options: ['å¸½å­','è…•æ™‚è¨ˆ','ãƒ™ãƒ«ãƒˆ','ãƒãƒ•ãƒ©ãƒ¼ãƒ»ã‚¹ãƒˆãƒ¼ãƒ«','ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼','ãã®ä»–'] }] },
          { title: 'â–¼ ç´ ææ„Ÿï¼ˆä»»æ„ï¼‰', collapsible: true, fields: [
            { type: 'pill', key: 'material', label: 'ç´ æ', options: ['å¸ƒãƒ»ãƒ‹ãƒƒãƒˆ','é©ãƒ»åˆçš®','é‡‘å±','ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯'] }
          ]},
          { title: 'å…±é€š', fields: [
            { type: 'pill', key: 'color', label: 'è‰²', options: commonColors, allowCustom: true, customKey: 'colorNote', customPlaceholder: 'è‰²ã‚’è¿½è¨˜ï¼ˆä»»æ„ï¼‰' },
            { type: 'text', key: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ­ã‚´å', placeholder: 'ä¾‹ï¼‰GUCCI / CASIO / ãƒ­ã‚´ãªã— ãªã©' },
            { type: 'text', key: 'note', label: 'ç‰¹å¾´ãƒ¡ãƒ¢', placeholder: 'ä¾‹ï¼‰è£…é£¾ã®å½¢ / ç•™ã‚å…·ã®ç‰¹å¾´ ãªã©' }
          ]}
        ]
      },
      glasses: {
        title: 'ãƒ¡ã‚¬ãƒãƒ»ã‚µãƒ³ã‚°ãƒ©ã‚¹ã®ç‰¹å¾´',
        sections: [
          { title: 'ç¨®é¡', fields: [{ type: 'pill', key: 'glassesType', options: ['åº¦ä»˜ããƒ¡ã‚¬ãƒ','ã‚µãƒ³ã‚°ãƒ©ã‚¹','è€çœ¼é¡'] }] },
          { title: 'â–¼ ãƒ•ãƒ¬ãƒ¼ãƒ å½¢çŠ¶ãƒ»å¤ªã•ï¼ˆä»»æ„ï¼‰', collapsible: true, fields: [
            { type: 'pill', key: 'frameShape', label: 'å½¢', options: ['ä¸¸','å››è§’','ãã®ä»–'] },
            { type: 'pill', key: 'frameThickness', label: 'å¤ªã•', options: ['ç´°ã‚','æ™®é€š','å¤ªã‚'] }
          ]},
          { title: 'å…±é€š', fields: [
            { type: 'pill', key: 'color', label: 'ãƒ•ãƒ¬ãƒ¼ãƒ è‰²', options: commonColors, allowCustom: true, customKey: 'colorNote', customPlaceholder: 'è‰²ã‚’è¿½è¨˜ï¼ˆä»»æ„ï¼‰' },
            { type: 'text', key: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ­ã‚´å', placeholder: 'ä¾‹ï¼‰Ray-Ban / JINS / ãƒ­ã‚´ãªã— ãªã©' },
            { type: 'text', key: 'note', label: 'ç‰¹å¾´ãƒ¡ãƒ¢', placeholder: 'ä¾‹ï¼‰ãƒ¬ãƒ³ã‚ºã«å‚· / ãƒ„ãƒ«ãŒæ›²ãŒã‚Šæ°—å‘³ ãªã©' }
          ]}
        ]
      },
      cosme: {
        title: 'åŒ–ç²§å“ãƒ»æ—¥ç”¨å“ã®ç‰¹å¾´',
        sections: [
          { title: 'ç¨®é¡', fields: [{ type: 'pill', key: 'cosmeType', options: ['ã‚¹ã‚­ãƒ³ã‚±ã‚¢','ãƒ¡ã‚¤ã‚¯','ãƒ˜ã‚¢ã‚±ã‚¢','ãã®ä»–æ—¥ç”¨å“'] }] },
          { title: 'â–¼ å½¢çŠ¶ï¼ˆä»»æ„ï¼‰', collapsible: true, fields: [
            { type: 'pill', key: 'cosmeShape', label: 'å½¢çŠ¶', options: ['ãƒœãƒˆãƒ«','ãƒãƒ¥ãƒ¼ãƒ–','ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ','ãƒ‘ãƒ¬ãƒƒãƒˆ','ãã®ä»–'] }
          ]},
          { title: 'å…±é€š', fields: [
            { type: 'pill', key: 'color', label: 'å®¹å™¨ã®è‰²', options: ['ç™½','é»’','ãƒ”ãƒ³ã‚¯','ã‚´ãƒ¼ãƒ«ãƒ‰','ãã®ä»–'], allowCustom: true, customKey: 'colorNote', customPlaceholder: 'è‰²ã‚’è¿½è¨˜ï¼ˆä»»æ„ï¼‰' },
            { type: 'text', key: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰', placeholder: 'ä¾‹ï¼‰è³‡ç”Ÿå ‚ / CHANEL / ç„¡å°' },
            { type: 'text', key: 'note', label: 'ç‰¹å¾´ãƒ¡ãƒ¢', placeholder: 'ä¾‹ï¼‰æ®‹é‡å°‘ãªã‚ / ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æŸ„ãªã©' }
          ]}
        ]
      },
      shoes: {
        title: 'é´ãƒ»ã‚µãƒ³ãƒ€ãƒ«ã®ç‰¹å¾´',
        sections: [
          { title: 'ç¨®é¡', fields: [{ type: 'pill', key: 'shoeType', options: ['ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼','ã‚µãƒ³ãƒ€ãƒ«','ãƒ–ãƒ¼ãƒ„','ãƒ‘ãƒ³ãƒ—ã‚¹ãƒ»ãƒ’ãƒ¼ãƒ«','å®¤å†…ç”¨ã‚¹ãƒªãƒƒãƒ‘'] }] },
          { title: 'ã‚µã‚¤ã‚º', fields: [
            { type: 'pill', key: 'sizeRange', label: 'ã‚µã‚¤ã‚º', options: ['ã€œ23','23ã€œ25','25ã€œ27','27ä»¥ä¸Š','ä¸æ˜'] }
          ]},
          { title: 'å…±é€š', fields: [
            { type: 'pill', key: 'color', label: 'è‰²', options: commonColors, allowCustom: true, customKey: 'colorNote', customPlaceholder: 'è‰²ã‚’è¿½è¨˜ï¼ˆä»»æ„ï¼‰' },
            { type: 'text', key: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰', placeholder: 'ä¾‹ï¼‰NIKE / adidas / ãƒ­ã‚´ãªã— ãªã©' },
            { type: 'text', key: 'note', label: 'ç‰¹å¾´ãƒ¡ãƒ¢', placeholder: 'ä¾‹ï¼‰ã‚½ãƒ¼ãƒ«ã®è‰² / ãƒ­ã‚´ä½ç½® ãªã©' }
          ]}
        ]
      },
      umbrella: {
        title: 'å‚˜ã®ç‰¹å¾´',
        sections: [
          { title: 'ç¨®é¡', fields: [{ type: 'pill', key: 'umbrellaType', options: ['é•·å‚˜','æŠ˜ã‚ŠãŸãŸã¿å‚˜'] }] },
          { title: 'è‰²ãƒ»é€æ˜åº¦', fields: [
            { type: 'pill', key: 'umbrellaColor', label: 'è‰²ãƒ»é€æ˜åº¦', options: ['ãƒ“ãƒ‹ãƒ¼ãƒ«é€æ˜','è‰²ä»˜ãé€æ˜','ä¸é€æ˜ï¼ˆé»’ãƒ»ç´ºï¼‰','ãã®ä»–'], allowCustom: true, customKey: 'umbrellaColorNote', customPlaceholder: 'è‰²ã‚’è¿½è¨˜ï¼ˆä»»æ„ï¼‰' }
          ]},
          { title: 'â–¼ æŸ„ï¼ˆä»»æ„ï¼‰', collapsible: true, fields: [
            { type: 'pill', key: 'pattern', label: 'æŸ„', options: ['ç„¡åœ°','ãƒ‰ãƒƒãƒˆ','èŠ±æŸ„','ãƒ­ã‚´ãƒ»ã‚¤ãƒ©ã‚¹ãƒˆå…¥ã‚Š'] }
          ]},
          { title: 'å…±é€š', fields: [
            { type: 'text', key: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆã‚ã‚Œã°ï¼‰', placeholder: 'ä»»æ„ã§è¨˜å…¥' },
            { type: 'text', key: 'note', label: 'ç‰¹å¾´ãƒ¡ãƒ¢', placeholder: 'ä¾‹ï¼‰éª¨ãŒ1æœ¬æ›²ãŒã‚Š / ã‚°ãƒªãƒƒãƒ—è‰²' }
          ]}
        ]
      },
      other: {
        title: 'ãã®ä»–ã®ç‰¹å¾´',
        sections: [
          { title: 'ã–ã£ãã‚Šç¨®é¡', fields: [{ type: 'pill', key: 'otherType', options: ['é›»å­æ©Ÿå™¨','ãƒãƒƒã‚°é¡','è¡£é¡ãƒ»å¸ƒã‚‚ã®','æ›¸é¡ãƒ»æœ¬ãƒ»ãƒãƒ¼ãƒˆ','é£Ÿã¹ç‰©ãƒ»ãŠåœŸç”£','ã“ã©ã‚‚ç”¨å“','ãã®ä»–'] }] },
          { title: 'å…±é€š', fields: [
            { type: 'pill', key: 'color', label: 'è‰²', options: commonColors, allowCustom: true, customKey: 'colorNote', customPlaceholder: 'è‰²ã‚’è¿½è¨˜ï¼ˆä»»æ„ï¼‰' },
            { type: 'text', key: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ­ã‚´', placeholder: 'ä»»æ„ã§è¨˜å…¥' },
            { type: 'text', key: 'note', label: 'ç‰¹å¾´ãƒ¡ãƒ¢', placeholder: 'è‡ªç”±å…¥åŠ›ï¼ˆå°‘ã—é•·ã‚OKï¼‰' }
          ]}
        ]
      },
      default: {
        title: 'ç‰¹å¾´ã‚’æ•™ãˆã¦ãã ã•ã„',
        sections: [
          { title: 'å…±é€š', fields: [
            { type: 'pill', key: 'color', label: 'è‰²', options: ['é»’','ç´º','ç™½','ã‚°ãƒ¬ãƒ¼','ãã®ä»–'], allowCustom: true, customKey: 'colorNote', customPlaceholder: 'è‰²ã‚’è¿½è¨˜ï¼ˆä»»æ„ï¼‰' },
            { type: 'text', key: 'brand', label: 'ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ­ã‚´å', placeholder: 'ä¾‹ï¼‰ãƒ–ãƒ©ãƒ³ãƒ‰å / ãƒ­ã‚´ãªã—' },
            { type: 'text', key: 'note', label: 'ç‰¹å¾´ãƒ¡ãƒ¢', placeholder: 'ã–ã£ãã‚Šã§OKã§ã™' }
          ]}
        ]
      }
    };

    function renderCategory() {
      view.innerHTML = `
        <div class="card">
          <h3>ã©ã‚“ãªè½ã¨ã—ç‰©ã§ã™ã‹ï¼Ÿ</h3>
          <p>ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã¶ã¨ã€ã“ã®å¾Œã®æ¤œç´¢ã‚„ä¿ç®¡ãŒã—ã‚„ã™ããªã‚Šã¾ã™ã€‚ã–ã£ãã‚Šã§å¤§ä¸ˆå¤«ã§ã™ã€‚</p>
          <div class="grid">
            ${categories.map(c => `
              <div class="option ${state.category===c.key?'active':''}" data-cat="${c.key}">
                <div style="font-weight:800;">${c.label}</div>
              </div>`).join('')}
          </div>
          <div id="miniForm"></div>
        </div>
      `;
      view.querySelectorAll('.option').forEach(opt => {
        opt.addEventListener('click', () => {
          const catKey = opt.dataset.cat;
          state.category = catKey;
          ensureForm(catKey);
          view.querySelectorAll('.option').forEach(o => o.classList.remove('active'));
          opt.classList.add('active');
          renderMiniForm();
          updateNextLabel();
        });
      });
      renderMiniForm();
    }

    function renderMiniForm() {
      const container = document.getElementById('miniForm');
      if (!state.category) {
        container.innerHTML = '';
        return;
      }
      const cfg = miniForms[state.category] || miniForms.default;
      const form = ensureForm(state.category);
      container.innerHTML = `
        <div class="mini-card slide-card">
          <div>
            <div style="font-weight:800; color:var(--heading);">${cfg.title || (lookupCategoryLabel(state.category) + 'ã®ç‰¹å¾´ã‚’æ•™ãˆã¦ãã ã•ã„')}</div>
            <div style="color:var(--muted); font-size:13px; font-weight:700;">å®Œç’§ã«æ›¸ã‹ãªãã¦å¤§ä¸ˆå¤«ã€‚ãƒ•ãƒ­ãƒ³ãƒˆãŒæ¢ã—ã‚„ã™ã„ç²’åº¦ã§ã€2ã€œ3é …ç›®ã§OKã§ã™ã€‚</div>
          </div>
          <div class="mini-fields"></div>
        </div>
      `;
      const sections = cfg.sections || [{ title: '', fields: cfg }];
      const fieldsEl = container.querySelector('.mini-fields');
      fieldsEl.innerHTML = sections.map(sec => renderMiniSection(sec, form)).join('');
      sections.forEach(sec => bindSectionEvents(sec, form, container));
    }

    function miniSummaryText() {
      const form = formState[state.category];
      if (!form) return state.note || 'â€•';
      const cfg = miniForms[state.category] || miniForms.default;
      const sections = cfg.sections || [{ fields: cfg }];
      const parts = [];
      sections.forEach(sec => {
        sec.fields.forEach(field => {
          if (field.showIf && !field.showIf(form)) return;
          if (field.type === 'pill') {
            if (form[field.key]) parts.push(form[field.key]);
            if (field.allowCustom && form[field.customKey]) parts.push(form[field.customKey]);
          } else if (field.type === 'text') {
            if (form[field.key]) parts.push(form[field.key]);
          } else if (field.type === 'toggle') {
            if (form[field.key]) parts.push(field.on);
          }
        });
      });
      const note = state.note ? `ãƒ¡ãƒ¢: ${state.note}` : '';
      return [ ...parts, note ].filter(Boolean).join(' / ') || 'â€•';
    }

    function renderMiniSection(section, form) {
      const open = section.collapsible ? form.__open[section.title] : true;
      const toggleBtn = section.collapsible ? `<button class="btn-ghost" style="padding:0; color:var(--muted-strong); font-size:12px;" data-sec="${section.title}">${open ? 'â–²' : 'â–¼'} ${section.title}</button>` : (section.title ? `<div class="label" style="font-weight:700; color:var(--muted-strong);">${section.title}</div>` : '');
      const fields = section.fields.filter(f => !f.showIf || f.showIf(form)).map(f => renderMiniField(f, form)).join('');
      const commonDivider = section.title && section.title.includes('å…±é€š') ? '<div class="mini-divider"></div>' : '';
      return `
        <div class="field" style="gap:6px;">
          ${section.title ? toggleBtn : ''}
          ${commonDivider}
          <div class="mini-section" data-sec="${section.title}" style="${section.collapsible && !open ? 'display:none;' : ''}">
            ${fields}
          </div>
        </div>
      `;
    }

    function renderMiniField(field, form) {
      if (field.type === 'pill') {
        return `
          <div class="field">
            ${field.label ? `<div class="label">${field.label}</div>` : ''}
            <div class="chips">
              ${field.options.map(opt => `<div class="chip ${form[field.key]===opt?'active':''}" data-key="${field.key}" data-value="${opt}">${opt}</div>`).join('')}
            </div>
            ${field.allowCustom ? `<input class="mini-input" data-key="${field.customKey}" type="text" placeholder="${field.customPlaceholder}" value="${form[field.customKey] || ''}">` : ''}
          </div>
        `;
      }
      if (field.type === 'text') {
        return `
          <div class="field">
            ${field.label ? `<div class="label">${field.label}</div>` : ''}
            <input class="mini-input" data-key="${field.key}" type="text" placeholder="${field.placeholder || ''}" value="${form[field.key] || ''}">
          </div>
        `;
      }
      if (field.type === 'toggle') {
        const on = form[field.key] === true;
        return `
          <div class="field">
            <div class="label">${field.label}</div>
            <div class="toggle ${on?'on':''}" data-key="${field.key}" data-on="${field.on}" data-off="${field.off}">
              <span>${on ? field.on : field.off}</span>
            </div>
          </div>
        `;
      }
      return '';
    }

    function bindSectionEvents(section, form, container) {
      if (section.collapsible) {
        const btn = container.querySelector(`button[data-sec="${section.title}"]`);
        const secEl = container.querySelector(`.mini-section[data-sec="${section.title}"]`);
        if (btn && secEl) {
          btn.addEventListener('click', () => {
            const open = !(form.__open[section.title]);
            form.__open[section.title] = open;
            secEl.style.display = open ? '' : 'none';
            btn.textContent = `${open ? 'â–²' : 'â–¼'} ${section.title}`;
          });
        }
      }
      (section.fields || []).forEach(field => bindFieldEvents(field, form));
    }

    function bindFieldEvents(field, form) {
      document.querySelectorAll('.chip[data-key]').forEach(chip => {
        chip.addEventListener('click', () => {
          const key = chip.dataset.key;
          form[key] = chip.dataset.value;
          renderMiniForm();
        });
      });
      document.querySelectorAll('.mini-input').forEach(input => {
        input.addEventListener('input', e => {
          form[e.target.dataset.key] = e.target.value;
        });
      });
      document.querySelectorAll('.toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
          const key = toggle.dataset.key;
          form[key] = !(form[key] === true);
          toggle.classList.toggle('on', form[key]);
          toggle.querySelector('span').textContent = form[key] ? toggle.dataset.on : toggle.dataset.off;
        });
      });
    }

    function renderPhoto() {
      view.innerHTML = `
          <div class="card" style="gap:8px;">
            <h3>å†™çœŸã‚’æ’®å½±ã—ã¦ãã ã•ã„</h3>
            <p>ã‚¿ã‚°ã‚’æ›¸ãå‰ã«å¿…ãšæ’®å½±ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰æ¤œç´¢ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚</p>
            <div class="photo" id="photoArea">
              ${state.photo ? `<img src="${state.photo}" alt="photo">` : '<div>ğŸ“· ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½±</div>'}
              <div class="hint">ãƒ•ãƒ©ãƒƒã‚·ãƒ¥è‡ªå‹•</div>
            </div>
            <div class="chips">
            <div class="chip active" style="background:#FFF;border-style:dashed;">1æšã§OK</div>
            <div class="chip" style="background:#FFF;border-style:dashed;">æ¨ªå‘ãæ¨å¥¨</div>
            <div class="chip" style="background:#FFF;border-style:dashed;">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚‚å†™ã™</div>
            </div>
            <div class="hint-inline">â€» ä»®æƒ³ã‚«ãƒ¡ãƒ©ã€‚ã‚¿ãƒƒãƒ—ã§ãƒ‡ãƒ¢ç”»åƒã‚’æŒ¿å…¥ã—ã¾ã™ã€‚</div>
          </div>
      `;
      document.getElementById('photoArea').addEventListener('click', () => {
        state.photo = 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?auto=format&fit=crop&w=600&q=80';
        render();
      });
    }

    function renderDetail() {
      view.innerHTML = `
        <div class="card">
          <h3>ã©ã“ã§ã€ã„ã¤è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã‹ï¼Ÿ</h3>
          <p>åˆ†ã‹ã‚‰ãªã„å ´åˆã¯ç©ºæ¬„ã®ã¾ã¾ã§OKã§ã™ã€‚</p>
          <div class="field">
            <div class="label">ç™ºè¦‹æ—¥</div>
            <div class="chips" style="gap:6px;">
              ${['ä»Šæ—¥','æ˜¨æ—¥','3æ—¥å‰','ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼'].map(d => `<div class="chip ${state.foundDate===d?'active':''}" data-date="${d}" style="font-size:10px;padding:6px 9px;">${d}</div>`).join('')}
            </div>
          </div>
          <div class="field">
            <div class="label">æ‹¾å¾—å ´æ‰€</div>
            <select id="placeSelect">
              ${['301å·å®¤','å¤§æµ´å ´','ãƒ­ãƒ“ãƒ¼','ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³','ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼å‰','å»Šä¸‹','ãã®ä»–'].map(p => `<option ${state.place===p?'selected':''}>${p}</option>`).join('')}
            </select>
          </div>
          <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <div class="field">
              <div class="label">éƒ¨å±‹ç•ªå·ï¼ˆä»»æ„ï¼‰</div>
              <input id="roomInput" type="text" value="${state.room}">
            </div>
            <div class="field">
              <div class="label" style="color:#9CA3AF;">å®¿æ³Šæ—¥ï¼ˆä»»æ„ï¼‰</div>
              <input id="stayInput" type="text" value="${state.stay}" placeholder="åˆ†ã‹ã‚‰ãªã„å ´åˆã¯ç©ºæ¬„">
            </div>
          </div>
          <div class="field">
            <div class="label">ç‰¹å¾´ãƒ¡ãƒ¢</div>
            <textarea id="noteInput" placeholder="ä¾‹ï¼‰é»’ã„é•·è²¡å¸ƒï¼é‡‘è‰²ãƒ•ã‚¡ã‚¹ãƒŠãƒ¼ï¼ãƒã‚±ãƒƒãƒˆã«é ˜åæ›¸">${state.note}</textarea>
          </div>
        </div>
      `;
      view.querySelectorAll('[data-date]').forEach(chip => {
        chip.addEventListener('click', () => {
          state.foundDate = chip.dataset.date;
          render();
        });
      });
      document.getElementById('placeSelect').addEventListener('change', e => state.place = e.target.value);
      document.getElementById('roomInput').addEventListener('input', e => state.room = e.target.value);
      document.getElementById('stayInput').addEventListener('input', e => state.stay = e.target.value);
      document.getElementById('noteInput').addEventListener('input', e => state.note = e.target.value);
    }

    function renderStorage() {
      view.innerHTML = `
        <div class="card">
          <h3>ä¿ç®¡å ´æ‰€ã¨ç¢ºèª</h3>
          <p>å€‰åº«ã¨æ£šã®ã©ã“ã«ç½®ãã‹ã‚’å…¥åŠ›ã—ã¾ã™ã€‚</p>
          <div class="field">
            <div class="label">ä¿ç®¡å ´æ‰€ <span class="hint-inline">ä¾‹ï¼‰å€‰åº«A-3 / ãƒ•ãƒ­ãƒ³ãƒˆæ£šB-2</span></div>
            <input id="storageInput" type="text" value="${state.storage}">
          </div>
          <div class="summary" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; border-style:solid; border-width:1px; border-color:#E5E7EB;">
            <div style="display:grid; gap:6px;">
              <div class="summary-row"><span>ã‚«ãƒ†ã‚´ãƒª</span><div>${lookupCategoryLabel(state.category)}</div></div>
              <div class="summary-row"><span>ç™ºè¦‹æ—¥</span><div>${state.foundDate}</div></div>
              <div class="summary-row"><span>æ‹¾å¾—å ´æ‰€</span><div>${state.place}</div></div>
            </div>
            <div style="display:grid; gap:6px;">
              <div class="summary-row"><span>ç‰¹å¾´</span><div>${miniSummaryText()}</div></div>
              <div class="summary-row"><span>ä¿ç®¡æœŸé™</span><div>${state.deadline}ï¼ˆã‚ã¨45æ—¥æƒ³å®šï¼‰</div></div>
            </div>
          </div>
          <div class="hint-inline" style="color:#6B7280;">â€» ç™»éŒ²å¾Œã«å†…å®¹ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</div>
          <div class="chips">
            <div class="chip active">å€‰åº«ãƒ«ãƒ¼ãƒ«ã‚’è‡ªå‹•é©ç”¨</div>
            <div class="chip">æœŸé™ã‚’æ‰‹å‹•è¨­å®š</div>
          </div>
        </div>
      `;
      document.getElementById('storageInput').addEventListener('input', e => state.storage = e.target.value);
    }

    function renderDone() {
      view.innerHTML = `
        <div class="done-card">
          <div class="done-check">âœ“</div>
          <div class="done-title">ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ</div>
          <div class="done-sub">ç®¡ç†ç•ªå·ãƒ©ãƒ™ãƒ«ã‚’è²¼ã£ã¦ã€æŒ‡å®šã®æ£šã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚</div>
          <div class="done-id"><span>ç®¡ç†ç•ªå·</span><strong>${state.id}</strong></div>
          <div class="done-meta">
            <div class="row"><span>ã‚«ãƒ†ã‚´ãƒª</span><strong>${lookupCategoryLabel(state.category)}</strong></div>
            <div class="row"><span>ä¿ç®¡å ´æ‰€</span><strong>${state.storage}</strong></div>
            <div class="row"><span>ä¿ç®¡æœŸé™</span><strong>${state.deadline}</strong></div>
            <div class="row"><span>ç‰¹å¾´</span><strong>${miniSummaryText()}</strong></div>
          </div>
          <div class="done-actions">
            <button class="btn btn-primary" id="doneRestart">ç¶šã‘ã¦ç™»éŒ²ã™ã‚‹</button>
            <button class="btn btn-outline" id="doneHome">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
          </div>
        </div>
      `;
      const restartBtn = document.getElementById('doneRestart');
      const homeBtn = document.getElementById('doneHome');
      if (restartBtn) restartBtn.addEventListener('click', () => { step = 0; render(); });
      if (homeBtn) homeBtn.addEventListener('click', () => { step = 0; render(); });
    }

    function validate() {
      if (step === 0 && !state.category) return 'ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„';
      if (step === 1 && !state.photo) return 'å†™çœŸã‚’æ’®å½±ã—ã¦ãã ã•ã„';
      if (step === 2 && !state.place) return 'æ‹¾å¾—å ´æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      if (step === 3 && !state.storage) return 'ä¿ç®¡å ´æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      return '';
    }

    nextBtn.addEventListener('click', () => {
      if (nextBtn.classList.contains('disabled')) return;
      const err = validate();
      if (err) { setToast(err); return; }
      if (step < 4) {
        step += 1;
        if (step === 4) setToast('è½ã¨ã—ç‰©ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
        render();
      } else {
        step = 0;
        render();
      }
    });

    backBtn.addEventListener('click', () => {
      if (step > 0) {
        step -= 1;
        render();
      }
    });

    render();
  </script>
</body>
</html>
